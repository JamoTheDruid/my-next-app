generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * AUTH / IDENTITY
 * - User is for login + permissions
 * - Roles are DB-backed (flexible)
 */

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String?    // Argon2 hash (nullable for Google-only accounts)
  provider     String?    // "google" etc.
  providerId   String?    
  name         String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  roles        UserRole[]
  customers    CustomerUser[]
  sessions     Session[]

  @@index([email])
  @@unique([provider, providerId])
}

model Session {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  revokedAt   DateTime?

  ipAddress   String?
  userAgent   String?
  lastSeenAt  DateTime?

  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])
}

enum RoleKey {
  ADMIN
  MANAGER
  EMPLOYEE
  CUSTOMER
  GUEST
}

model Role {
  id        String    @id @default(cuid())
  key       RoleKey   @unique
  name      String
  system    Boolean   @default(false)
  createdAt DateTime  @default(now())

  users     UserRole[]
}

model UserRole {
  userId     String
  roleId     String
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
  @@index([userId])
}

/**
 * BUSINESS ENTITIES
 * - Customer exists with or without a login
 * - CustomerUser links logins to business records (supports multiple household logins)
 */

enum CustomerStatus {
  LEAD
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum CustomerUserRelation {
  OWNER
  MEMBER
  BILLING
}

model Customer {
  id          String         @id @default(cuid())
  name        String
  email       String?        @unique
  telephone   String?
  addressRaw  String?
  status      CustomerStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  properties  Property[]
  users       CustomerUser[]
  projects    Project[]
  finances    Finance[]

  @@index([email])
  @@index([status])
}

model CustomerUser {
  customerId String
  userId     String
  relation   CustomerUserRelation @default(OWNER)
  isPrimary  Boolean              @default(true)
  createdAt  DateTime             @default(now())

  customer   Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([customerId, userId])
  @@index([userId])
  @@index([customerId])
}

/**
 * OPERATIONS
 */

model Property {
  id          String    @id @default(cuid())
  address     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  String

  files       File[]
  finances    Finance[]

  @@index([customerId])
}

model Project {
  id          String    @id @default(cuid())
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  String
  finances   Finance[]

  @@index([customerId])
}

model Finance {
  id          String    @id @default(cuid())
  type        String
  amount      Float
  date        DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  String
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId   String?
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId  String?

  @@index([customerId])
}

model File {
  id           String   @id @default(cuid())
  originalName String
  storageKey   String   @unique
  publicUrl    String?
  fileSize     Int?
  mimeType     String?
  createdAt    DateTime @default(now())

  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId   String

  @@index([propertyId])
}

model JournalEntry {
  id              String    @id @default(cuid())
  title           String
  debitAccountId  String
  creditAccountId String
  amount          Float
  content         String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Account {
  id          String    @id @default(cuid())
  name        String
  balance     Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model AngiLead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // basic info
  name          String
  firstName      String
  lastName       String
  email          String
  address        String
  city           String
  stateProvince  String
  postalCode     String

  // phones
  primaryPhone        String
  phoneExt            String?
  secondaryPhone      String?
  secondaryPhoneExt   String?
  primaryMaskedNumber Boolean @default(false)

  // angi identifiers / metadata
  srOid        BigInt
  leadOid      BigInt @unique
  fee          Decimal
  taskName     String
  comments     String
  matchType    String
  leadDescription String
  spEntityId   BigInt
  spCompanyName String
  contactStatus String
  crmKey       String?
  leadSource   String
  trustedFormUrl String?
  automatedContactCompliant Boolean
  automatedContactConsentId String?

  interview AngiInterviewEntry[]
}

model AngiInterviewEntry {
  id        String   @id @default(cuid())
  leadId    String
  lead      AngiLead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  question  String
  answer    String
}
